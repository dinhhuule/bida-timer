<!DOCTYPE html>
<html>
<head>
    <title>Billiards Timer Dashboard</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #333; /* Màu nền tối */
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 cột */
            gap: 20px;
            width: 90%;
            max-width: 1200px;
        }

        .timer-card {
            background-color: #222;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.5s, border 0.5s;
            border: 5px solid transparent;
        }

        .table-label {
            font-size: 2em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .timer-display {
            font-size: 5em;
            font-weight: bold;
            letter-spacing: 5px;
            color: #ccc; /* Màu chữ mặc định */
        }

        /* TRẠNG THÁI MÀU */

        /* Bàn Đang Hoạt Động (Màu Xanh Dương) */
        .status-playing {
            border-color: #007bff;
            background-color: #0056b3;
        }
        .status-playing .timer-display {
            color: #ffffff;
        }

        /* Bàn Không Hoạt Động (Màu Xám) */
        .status-inactive {
            border-color: #555;
            background-color: #444;
        }
        .status-inactive .timer-display {
            color: #888;
        }

        /* CẢNH BÁO (Màu Cam/Vàng) */
        .status-warning {
            border-color: #ffc107;
            background-color: #e0a800;
        }
        .status-warning .timer-display {
            color: #333;
        }

        /* HẾT GIỜ (Màu Đỏ) */
        .status-expired {
            border-color: #dc3545;
            background-color: #c82333;
        }
        .status-expired .timer-display {
            color: #fff;
        }
        
        /* Hiệu ứng nhấp nháy khi Hết giờ/Lố giờ */
        .blinking {
            animation: blinker 0.8s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="timer-card status-inactive" id="table-0">
            <div class="table-label">BÀN LỖ 1</div>
            <div class="timer-display">00:00:00</div>
        </div>

        <div class="timer-card status-inactive" id="table-1">
            <div class="table-label">BÀN LỖ 2</div>
            <div class="timer-display">00:00:00</div>
        </div>

        <div class="timer-card status-inactive" id="table-2">
            <div class="table-label">BÀN LỖ 3</div>
            <div class="timer-display">00:00:00</div>
        </div>

        <div class="timer-card status-inactive" id="table-3">
            <div class="table-label">BÀN LỖ 4</div>
            <div class="timer-display">00:00:00</div>
        </div>
    </div>

   <script>
        // **********************************
        // *** THAY ĐỔI 4 LIÊN KẾT NÀY ***
        // Đã chuyển sang định dạng /export?format=tsv (khắc phục lỗi CORS/Download)
        const GID = "1591875034"; // ID Trang tính của bạn
        // ID Tài liệu ngắn (Lấy từ URL trình duyệt của bạn)
        const DOC_ID = "10fuZqo17P59EIoM-3hQ0g0t-m7MirPG_YHZfi5M0qkVf"; 

        const TABLE_CONFIG = [
            // Bàn Lỗ 1 sẽ đọc dữ liệu từ C2
            { id: 0, sheetUrl: `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=tsv&gid=${GID}&range=C2` }, 
            // Bàn Lỗ 2 sẽ đọc dữ liệu từ C3
            { id: 1, sheetUrl: `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=tsv&gid=${GID}&range=C3` }, 
            // Bàn Lỗ 3 sẽ đọc dữ liệu từ C4
            { id: 2, sheetUrl: `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=tsv&gid=${GID}&range=C4` }, 
            // Bàn Lỗ 4 sẽ đọc dữ liệu từ C5
            { id: 3, sheetUrl: `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=tsv&gid=${GID}&range=C5` }
        ];
        // **********************************

        const timers = TABLE_CONFIG.map(config => ({
            ...config,
            endTime: null,
            totalSecondsFromSheet: 0,
            domElement: document.getElementById(`table-${config.id}`),
            displayElement: document.querySelector(`#table-${config.id} .timer-display`)
        }));

        const FIVE_MINUTES_MS = 300 * 1000;

        // Hàm gọi dữ liệu từ Google Sheets cho TẤT CẢ 4 bàn
        async function fetchAllSheetsTime() {
            const fetchPromises = timers.map(timer => 
                fetch(timer.sheetUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Lỗi bàn ${timer.id + 1}: ${response.status}`);
                        return response.text();
                    })
                    .then(text => {
                        const totalSeconds = parseFloat(text.trim());
                        return { timer, totalSeconds };
                    })
                    .catch(error => {
                        console.error(`Lỗi lấy dữ liệu cho Bàn ${timer.id + 1}:`, error);
                        return { timer, totalSeconds: -1 }; 
                    })
            );

            const results = await Promise.all(fetchPromises);

            results.forEach(({ timer, totalSeconds }) => {
                if (totalSeconds === -1) {
                    timer.totalSecondsFromSheet = 0;
                    timer.endTime = null;
                    return;
                }

                if (totalSeconds > 0 && totalSeconds !== timer.totalSecondsFromSheet) {
                    timer.totalSecondsFromSheet = totalSeconds;
                    startTimerLogic(timer, totalSeconds);
                } else if (totalSeconds <= 0 && timer.totalSecondsFromSheet !== 0) {
                     timer.totalSecondsFromSheet = 0;
                     timer.endTime = null;
                }
            });
        }

        // ... (Phần code còn lại giữ nguyên) ...

        // Logic khởi động Timer
        function startTimerLogic(timer, totalSeconds) {
            const durationMs = totalSeconds * 1000;
            timer.endTime = Date.now() + durationMs;

            timer.domElement.classList.remove('status-inactive', 'status-warning', 'status-expired');
            timer.displayElement.classList.remove('blinking');
        }

        // Hàm cập nhật tất cả các đồng hồ
        function updateAllTimers() {
            timers.forEach(timer => {
                const now = Date.now();

                if (!timer.endTime || timer.totalSecondsFromSheet === 0) {
                    timer.domElement.className = 'timer-card status-inactive';
                    timer.displayElement.textContent = "00:00:00";
                    return;
                }

                let timeLeftMs = timer.endTime - now;

                timer.domElement.classList.remove('status-inactive', 'status-playing', 'status-warning', 'status-expired');
                timer.displayElement.classList.remove('blinking');

                if (timeLeftMs <= 0) {
                    timeLeftMs = Math.abs(timeLeftMs); 
                    timer.domElement.classList.add('status-expired');
                    timer.displayElement.classList.add('blinking');

                    const timeString = formatTime(timeLeftMs);
                    timer.displayElement.textContent = "-" + timeString;
                    return;
                } 

                if (timeLeftMs < FIVE_MINUTES_MS) {
                    timer.domElement.classList.add('status-warning');
                } else {
                    timer.domElement.classList.add('status-playing');
                }

                const timeString = formatTime(timeLeftMs);
                timer.displayElement.textContent = timeString;
            });
        }

        // Hàm chuyển đổi mili giây sang HH:MM:SS
        function formatTime(ms) {
            let totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => num.toString().padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        // Khởi tạo
        fetchAllSheetsTime();
        setInterval(updateAllTimers, 1000); 
        setInterval(fetchAllSheetsTime, 5000); 
    </script>
</body>
</html>
